<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial News Sentiment Analyzer</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">
        
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400 mb-2">MarketSense</h1>
            <p class="text-gray-400">Enter a stock ticker to analyze the latest news sentiment.</p>
        </header>

        <!-- Input Form -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <form id="ticker-form" class="flex flex-col sm:flex-row gap-4">
                <input 
                    type="text" 
                    id="ticker-input" 
                    placeholder="e.g., AAPL, TSLA, GOOGL" 
                    class="flex-grow bg-gray-700 text-white placeholder-gray-500 rounded-lg px-4 py-3 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition duration-200"
                >
                <button 
                    type="submit" 
                    class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-75"
                >
                    Analyze Sentiment
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <main id="results-section">
            <!-- Loading Spinner -->
            <div id="loader" class="hidden justify-center items-center py-8">
                <div class="spinner"></div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg text-center"></div>

            <!-- Overall Sentiment -->
            <div id="overall-sentiment" class="hidden text-center bg-gray-800 p-4 rounded-xl mb-6">
                <h2 class="text-xl font-semibold">Overall Sentiment</h2>
                <p id="overall-sentiment-text" class="text-3xl font-bold mt-2"></p>
            </div>

            <!-- News Articles List -->
            <div id="articles-container" class="space-y-4">
                <!-- Articles will be injected here by JavaScript -->
            </div>
        </main>

    </div>

    <script>
        // --- CONFIGURATION ---
        const BACKEND_URL = 'http://localhost:5000'; // Flask backend URL

        // --- DOM ELEMENT REFERENCES ---
        const form = document.getElementById('ticker-form');
        const input = document.getElementById('ticker-input');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const overallSentimentContainer = document.getElementById('overall-sentiment');
        const overallSentimentText = document.getElementById('overall-sentiment-text');
        const articlesContainer = document.getElementById('articles-container');

        // --- EVENT LISTENER ---
        form.addEventListener('submit', handleFormSubmit);

        /**
         * Handles the form submission event.
         * @param {Event} e - The form submission event.
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            const ticker = input.value.trim().toUpperCase();
            
            if (!ticker) {
                displayError('Please enter a stock ticker.');
                return;
            }

            // Reset UI for new analysis
            resetUI();
            loader.classList.remove('hidden');
            loader.classList.add('flex');

            try {
                // Fetch analyzed data from Flask backend
                const analyzedData = await fetchSentimentAnalysis(ticker);

                if (!analyzedData.articles || analyzedData.articles.length === 0) {
                    displayError(`No recent news found for the ticker "${ticker}".`);
                    return;
                }

                // Display the results on the page
                displayResults(analyzedData);

            } catch (error) {
                console.error('Error:', error);
                displayError(error.message);
            } finally {
                // Hide loader regardless of outcome
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }

        /**
         * Fetches sentiment analysis data from the Flask backend.
         * @param {string} ticker - The stock ticker symbol.
         * @returns {Promise<Object>} A promise that resolves to analyzed data.
         */
        async function fetchSentimentAnalysis(ticker) {
            const response = await fetch(`${BACKEND_URL}/api/sentiment/${ticker}`);

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Failed to fetch analysis: ${errorData.error || response.statusText}`);
            }

            return await response.json();
        }

        /**
         * Displays the analyzed articles and overall sentiment on the page.
         * @param {Object} data - The analyzed data containing articles and overall sentiment.
         */
        function displayResults(data) {
            // Display overall sentiment
            const { text, colorClass } = getSentimentDetails(data.overall_sentiment);
            overallSentimentText.textContent = `${text} (Score: ${data.overall_sentiment.toFixed(2)})`;
            overallSentimentText.className = `text-3xl font-bold mt-2 ${colorClass}`;
            overallSentimentContainer.classList.remove('hidden');

            // Display each article
            data.articles.forEach(article => {
                const articleElement = createArticleCard(article);
                articlesContainer.appendChild(articleElement);
            });
        }

        /**
         * Creates an HTML element for a single news article card.
         * @param {object} article - The article data.
         * @returns {HTMLElement} The created card element.
         */
        function createArticleCard(article) {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-cyan-500 transition duration-200';

            const sentimentDetails = getSentimentDetails(article.sentiment.score);

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="text-lg font-semibold text-gray-100 mb-2">
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="hover:text-cyan-400">
                            ${article.title}
                        </a>
                    </h3>
                    <span class="text-sm font-medium ${sentimentDetails.colorClass} bg-gray-700 px-2 py-1 rounded-md ml-4 flex-shrink-0">
                        ${sentimentDetails.text} (${article.sentiment.score.toFixed(2)})
                    </span>
                </div>
                <p class="text-gray-300 mt-2 text-sm">${article.description || 'No description available.'}</p>
                <p class="text-sm text-gray-400 mt-2">
                    Source: ${article.source.name} | 
                    ${new Date(article.publishedAt).toLocaleDateString()}
                </p>
            `;
            return card;
        }

        /**
         * Determines the sentiment label and color based on a score.
         * @param {number} score - The sentiment score.
         * @returns {{text: string, colorClass: string}}
         */
        function getSentimentDetails(score) {
            if (score > 1) return { text: 'Very Positive', colorClass: 'text-green-500' };
            if (score > 0.5) return { text: 'Positive', colorClass: 'text-green-400' };
            if (score > 0.1) return { text: 'Slightly Positive', colorClass: 'text-green-300' };
            if (score < -1) return { text: 'Very Negative', colorClass: 'text-red-500' };
            if (score < -0.5) return { text: 'Negative', colorClass: 'text-red-400' };
            if (score < -0.1) return { text: 'Slightly Negative', colorClass: 'text-red-300' };
            return { text: 'Neutral', colorClass: 'text-yellow-400' };
        }

        /**
         * Displays an error message in the UI.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        /**
         * Resets the UI to its initial state before a new analysis.
         */
        function resetUI() {
            errorMessage.classList.add('hidden');
            overallSentimentContainer.classList.add('hidden');
            articlesContainer.innerHTML = '';
        }

    </script>
</body>
</html>